name: Build & Deploy to ECS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Build JAR
      run: mvn clean package -DskipTests

    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build & Push Docker Image
      id: build-image
      run: |
        docker build -t health-api .
        docker tag health-api:latest 336449586386.dkr.ecr.us-east-1.amazonaws.com/health-api:latest
        docker push 336449586386.dkr.ecr.us-east-1.amazonaws.com/health-api:latest
        
        # Output the image URI for the next step
        echo "image=336449586386.dkr.ecr.us-east-1.amazonaws.com/health-api:latest" >> $GITHUB_OUTPUT

    - name: Fill in the new image ID in the Amazon ECS task definition
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: task-definition.json
        container-name: health-api-container  # Must match the "name" in your JSON
        image: ${{ steps.build-image.outputs.image }}

    - name: Execute Deployment Script
      run: |
          REGION=us-east-1
          REPOSITORY_NAME=health-api
          CLUSTER=health-api-cluster
          # Extract family and name from your local json
          FAMILY=$(jq -r '.family' task-definition.json)
          NAME=$(jq -r '.containerDefinitions[0].name' task-definition.json)
          SERVICE_NAME=health-api-service
          IMAGE_TAG=${{ github.sha }}
          
          # 1. Get Repository URI
          REPOSITORY_URI=$(aws ecr describe-repositories --repository-names ${REPOSITORY_NAME} --region ${REGION} | jq -r .repositories[].repositoryUri)
          
          # 2. Update JSON with the new Image URI
          # Note: Ensure your json file has a placeholder like "IMAGE_PLACEHOLDER" or use jq to inject it
          jq --arg IMG "$REPOSITORY_URI:$IMAGE_TAG" '.containerDefinitions[0].image = $IMG' task-definition.json > final-taskdef.json

          # 3. Register the task definition and get the new Revision
          NEW_TASK_INFO=$(aws ecs register-task-definition --cli-input-json file://final-taskdef.json --region ${REGION})
          REVISION=$(echo $NEW_TASK_INFO | jq -r .taskDefinition.revision)

          # 4. Check if service exists (Failures array will be empty if service exists)
          SERVICE_EXISTS=$(aws ecs describe-services --services ${SERVICE_NAME} --cluster ${CLUSTER} --region ${REGION} | jq -r '.services | length')

          if [ "$SERVICE_EXISTS" -gt "0" ]; then
            echo "Updating existing service to revision $REVISION..."
            aws ecs update-service --cluster ${CLUSTER} --region ${REGION} --service ${SERVICE_NAME} --task-definition ${FAMILY}:${REVISION}
          else
            echo "Creating new EC2 service with awsvpc networking..."
            
            # 5. Automatically fetch Subnets and a Security Group (Required for awsvpc mode)
            # Replace these filters if you want specific subnets
            SUBNETS=$(aws ec2 describe-subnets --region ${REGION} --query 'Subnets[*].SubnetId' --output text | sed 's/\t/,/g')
            SEC_GROUP=$(aws ec2 describe-security-groups --region ${REGION} --group-names "default" --query 'SecurityGroups[0].GroupId' --output text)

            aws ecs create-service \
              --service-name ${SERVICE_NAME} \
              --cluster ${CLUSTER} \
              --region ${REGION} \
              --task-definition ${FAMILY}:${REVISION} \
              --launch-type EC2 \
              --desired-count 1 \
              --network-configuration "awsvpcConfiguration={subnets=[$SUBNETS],securityGroups=[$SEC_GROUP],assignPublicIp=DISABLED}"
          fi
